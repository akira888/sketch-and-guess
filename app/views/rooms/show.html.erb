<%= turbo_stream_from @cache_room.room_channel %>

<div class="waiting-room">
  <h1 class="page-title">å¾…æ©Ÿä¸­...</h1>

  <div class="room-info-card">
    <h2 class="card-title">ãƒ«ãƒ¼ãƒ æƒ…å ±</h2>
    <div class="info-content">
      <div class="info-item">
        <span class="info-label">ãƒ«ãƒ¼ãƒ ID</span>
        <span class="info-value"><%= @cache_room.id %></span>
      </div>
      <div class="info-item">
        <span class="info-label">å‚åŠ äººæ•°</span>
        <span class="info-value" id="participant-count"><%= @cache_room.entering_count %> / <%= @cache_room.member_limit %> äºº</span>
      </div>
    </div>
  </div>

  <div id="participants" class="participants-card">
    <h2 class="card-title">å‚åŠ è€…ä¸€è¦§</h2>
    <ul class="participants-list">
      <% @cache_room.member_order_array.each do |member| %>
        <li class="participant-item">
          <span class="participant-icon">ğŸ‘¤</span>
          <span class="participant-name"><%= member["user_name"] %></span>
        </li>
      <% end %>
    </ul>
  </div>

  <div id="room-status">
    <% if @cache_room.full? %>
      <div class="game-starting">
        <div class="starting-icon">ğŸ®</div>
        <h2>å…¨å“¡æƒã„ã¾ã—ãŸï¼</h2>
        <p>ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹ã—ã¦ã„ã¾ã™...</p>
        <p class="auto-redirect">è‡ªå‹•çš„ã«ã‚²ãƒ¼ãƒ ç”»é¢ã«ç§»å‹•ã—ã¾ã™</p>
      </div>
    <% else %>
      <div class="invitation-card">
        <h2 class="card-title">å‹é”ã‚’æ‹›å¾…</h2>
        <p class="invitation-text">å‚åŠ ã—ãŸã„ãƒ¡ãƒ³ãƒãƒ¼ã«ä»¥ä¸‹ã®URLã‚’ä¼ãˆã‚‹ã‹ã€QRã‚³ãƒ¼ãƒ‰ã‚’é€ã£ã¦ãã ã•ã„</p>
        <div class="invitation-content">
          <div class="url-section">
            <label class="section-label">ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²URL</label>
            <%= link_to user_entry_url(@cache_room.id), user_entry_url(@cache_room.id), target: "_blank", class: "invite-link" %>
          </div>
          <div class="qr-section">
            <label class="section-label">QRã‚³ãƒ¼ãƒ‰</label>
            <%= image_tag qrcode_tag(user_entry_url(@cache_room.id)), class: "qr-code" %>
          </div>
        </div>
        <p class="waiting-message">
          <span class="waiting-icon">â³</span>
          ã‚ã¨ <strong><%= @cache_room.member_limit - @cache_room.entering_count %></strong> äººå¾…ã£ã¦ã„ã¾ã™...
        </p>
      </div>
    <% end %>
  </div>
</div>

<style>
  .waiting-room {
    max-width: 900px;
    margin: 40px auto;
    padding: 20px;
  }

  .page-title {
    text-align: center;
    font-size: 48px;
    color: #FF6B6B;
    margin-bottom: 40px;
    font-family: 'Comic Sans MS', 'Chalkboard SE', cursive, sans-serif;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
  }

  .room-info-card {
    background: linear-gradient(135deg, #FFF9E6 0%, #FFE4B5 100%);
    padding: 25px;
    border-radius: 15px;
    margin-bottom: 25px;
    border: 3px solid #D4A574;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  }

  .card-title {
    margin: 0 0 20px 0;
    font-size: 24px;
    color: #2C1810;
    font-family: 'Comic Sans MS', 'Chalkboard SE', cursive, sans-serif;
    text-align: center;
  }

  .info-content {
    display: flex;
    gap: 20px;
    justify-content: center;
    flex-wrap: wrap;
  }

  .info-item {
    background: white;
    padding: 15px 30px;
    border-radius: 12px;
    border: 2px solid #D4A574;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
  }

  .info-label {
    font-size: 14px;
    color: #666;
    font-weight: bold;
  }

  .info-value {
    font-size: 24px;
    color: #FF6B6B;
    font-weight: bold;
    font-family: 'Comic Sans MS', 'Chalkboard SE', cursive, sans-serif;
  }

  .participants-card {
    background: linear-gradient(135deg, #E8F4F8 0%, #D4EDF4 100%);
    padding: 25px;
    border-radius: 15px;
    margin-bottom: 25px;
    border: 3px solid #4ECDC4;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  }

  .participants-list {
    list-style: none;
    padding: 0;
    margin: 0;
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 12px;
  }

  .participant-item {
    background: white;
    padding: 15px 20px;
    border-radius: 25px;
    border: 2px solid #4ECDC4;
    display: flex;
    align-items: center;
    gap: 10px;
    transition: all 0.3s ease;
  }

  .participant-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(78, 205, 196, 0.3);
  }

  .participant-icon {
    font-size: 20px;
  }

  .participant-name {
    font-size: 16px;
    font-weight: bold;
    color: #333;
  }

  .game-starting {
    text-align: center;
    padding: 40px;
    background: linear-gradient(135deg, #D4EDDA 0%, #C3E6CB 100%);
    border: 3px solid #28A745;
    border-radius: 20px;
    box-shadow: 0 6px 16px rgba(40, 167, 69, 0.3);
  }

  .starting-icon {
    font-size: 64px;
    margin-bottom: 20px;
    animation: bounce 1s infinite;
  }

  @keyframes bounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-10px); }
  }

  .game-starting h2 {
    margin: 0 0 15px 0;
    font-size: 32px;
    color: #155724;
    font-family: 'Comic Sans MS', 'Chalkboard SE', cursive, sans-serif;
  }

  .game-starting p {
    margin: 10px 0;
    font-size: 18px;
    color: #155724;
  }

  .auto-redirect {
    font-style: italic;
    color: #28A745 !important;
  }

  .invitation-card {
    background: linear-gradient(135deg, #FFF9E6 0%, #FFE4B5 100%);
    padding: 30px;
    border-radius: 20px;
    border: 3px solid #D4A574;
    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
  }

  .invitation-text {
    text-align: center;
    color: #666;
    margin-bottom: 25px;
    font-size: 16px;
  }

  .invitation-content {
    display: flex;
    gap: 30px;
    margin: 25px 0;
    flex-wrap: wrap;
    justify-content: center;
  }

  .url-section,
  .qr-section {
    flex: 1;
    min-width: 250px;
    background: white;
    padding: 20px;
    border-radius: 12px;
    border: 2px solid #D4A574;
  }

  .section-label {
    display: block;
    font-weight: bold;
    margin-bottom: 12px;
    color: #2C1810;
    font-size: 14px;
  }

  .invite-link {
    display: block;
    color: #4ECDC4;
    text-decoration: none;
    word-break: break-all;
    font-size: 14px;
    padding: 10px;
    background: #F0F8FF;
    border-radius: 8px;
    border: 1px dashed #4ECDC4;
  }

  .invite-link:hover {
    background: #E0F0FF;
    text-decoration: underline;
  }

  .qr-code {
    max-width: 200px;
    height: auto;
    display: block;
    margin: 0 auto;
    border: 3px solid #D4A574;
    border-radius: 8px;
    padding: 10px;
    background: white;
  }

  .waiting-message {
    text-align: center;
    font-size: 24px;
    font-weight: bold;
    color: #FF9800;
    margin-top: 30px;
    padding: 20px;
    background: rgba(255, 152, 0, 0.1);
    border-radius: 15px;
    border: 2px dashed #FF9800;
    font-family: 'Comic Sans MS', 'Chalkboard SE', cursive, sans-serif;
  }

  .waiting-icon {
    font-size: 28px;
    display: inline-block;
    animation: pulse 2s infinite;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }

  /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
  @media (max-width: 768px) {
    .waiting-room {
      padding: 15px;
    }

    .waiting-room h1 {
      font-size: 24px;
      margin-bottom: 20px;
    }

    .room-info {
      padding: 15px;
    }

    .room-info h2 {
      font-size: 18px;
    }

    .room-info p {
      font-size: 14px;
    }

    .participants {
      padding: 15px;
    }

    .participants h2 {
      font-size: 18px;
    }

    .participants li {
      padding: 8px;
      font-size: 14px;
    }

    .game-starting {
      padding: 20px;
    }

    .game-starting h2 {
      font-size: 20px;
    }

    .game-starting p {
      font-size: 14px;
    }

    .invitation {
      padding: 15px;
    }

    .invitation h2 {
      font-size: 16px;
    }

    .invitation dd img {
      max-width: 150px;
    }

    .waiting-message {
      font-size: 16px;
    }
  }

  @media (max-width: 480px) {
    .waiting-room h1 {
      font-size: 20px;
    }

    .room-info h2,
    .participants h2 {
      font-size: 16px;
    }

    .game-starting h2 {
      font-size: 18px;
    }

    .invitation h2 {
      font-size: 14px;
    }

    .waiting-message {
      font-size: 14px;
    }
  }
</style>

<script>
// ã‚²ãƒ¼ãƒ çŠ¶æ…‹ã®å®šæœŸãƒã‚§ãƒƒã‚¯
(function() {
  const roomId = '<%= @cache_room.id %>';

  // 2ç§’ã”ã¨ã«ã‚²ãƒ¼ãƒ çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯
  const checkInterval = setInterval(() => {
    fetch(`/rooms/${roomId}/game_redirect`, {
      headers: {
        'Accept': 'application/json'
      }
    })
    .then(response => response.json())
    .then(data => {
      // ãŠé¡Œé¸æŠãƒ•ã‚§ãƒ¼ã‚ºã«ç§»è¡Œã—ãŸã‹ãƒã‚§ãƒƒã‚¯
      if (data.game_status === 'prompt_selection') {
        console.log('ãŠé¡Œé¸æŠãƒ•ã‚§ãƒ¼ã‚ºã«ç§»è¡Œã—ã¾ã—ãŸ');
        clearInterval(checkInterval);
        window.location.href = `/rooms/${roomId}/prompt_selection`;
      }
      // ã‚²ãƒ¼ãƒ ãŒé–‹å§‹ã•ã‚ŒãŸã‹ãƒã‚§ãƒƒã‚¯
      else if (data.sketch_book_url) {
        console.log('ã‚²ãƒ¼ãƒ ãŒé–‹å§‹ã•ã‚Œã¾ã—ãŸ');
        clearInterval(checkInterval);
        window.location.href = data.sketch_book_url;
      }
    })
    .catch(err => console.error('Status check failed:', err));
  }, 2000);
})();
</script>
